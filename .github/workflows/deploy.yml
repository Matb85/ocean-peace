name: Deploy
on:
  push:
    workflow_dispatch:
    branches:
      - master
jobs:
  deploy:
    runs-on: [self-hosted, ovh]
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node 16
        run: source ~/.nvm/nvm.sh && nvm use && echo $PATH >>"${GITHUB_PATH}"

      - name: Bootstrap dependencies
        run: node --version && pnpm --version && pnpm --filter web i --no-frozen-lockfile

      - name: Build
        run: "pnpm --filter web build"

      - name: Lint
        run: pnpm --filter web check

      - name: Copy app files
        run: |
          rsync -avh --delete \
          ./platforms/web/build/* \
          ${{ secrets.REMOTE_SERVER }}:${{ secrets.REMOTE_TARGET_DEV }}
