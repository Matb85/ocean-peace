name: Release

concurrency: ${{ github.workflow }}-${{ github.ref }}

on:
  push:
    branches:
      - master
      - next

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install SSH key for Design System
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_ed25519_design_system # optional
          known_hosts: "|1|r2GtBiIWDfKxTeQNSzBCec0o7aY=|JucDoGUfPPyGD2WdSLxbN5EmiLE= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg="
          config: |
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_design_system

      - name: Setup Node.js 16.x
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: install pnpm
        run: npm i pnpm @lerna-lite/cli -g && pnpm --no-frozen-lockfile --filter "@redinn/*" install

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: "pnpm-lock.yaml"
          author_name: Redinn Bot
          author_email: bot@redinnlabs.com
          message: "chore: :pushpin: update pnpm-lock.yaml"
          pathspec_error_handling: ignore

      - name: Version and publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor}}@users.noreply.github.com"

          if [ ${{ github.base_ref }} = next ]; then
            lerna version --conventional-commits --conventional-prerelease --preid beta --yes --create-release github
          else
            lerna version --conventional-commits --yes --create-release github
          fi
